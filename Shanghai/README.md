This is a fork of https://gist.github.com/evancz/8521339

Fixes a few things, couldn't fork on github because of a gist bug.
